<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analysis Service</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• Video Analysis Service</h1>
            <p>Upload videos, analyze people, and track faces</p>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="showTab('videos')">Videos</button>
            <button class="tab-btn" onclick="showTab('analysis')">Analysis</button>
            <button class="tab-btn" onclick="showTab('finder')">Person Finder</button>
            <button class="tab-btn" onclick="showTab('health')">Health</button>
        </nav>

        <!-- Videos Tab -->
        <div id="videos" class="tab-content active">
            <div class="section">
                <h2>Upload Video</h2>
                <form id="uploadForm" class="upload-form">
                    <div class="file-input-wrapper">
                        <input type="file" id="videoFile" accept="video/*" required>
                        <label for="videoFile" class="file-label">
                            <span class="file-icon">üìÅ</span>
                            <span class="file-text">Choose video file...</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload Video</button>
                </form>
            </div>

            <div class="section">
                <h2>Uploaded Videos</h2>
                <div id="videosList" class="data-list">
                    <div class="loading">Loading videos...</div>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="section">
                <h2>Video Analysis</h2>
                <div class="analysis-controls">
                    <select id="videoSelect" class="select-input">
                        <option value="">Select a video...</option>
                    </select>
                    <button id="startAnalysisBtn" class="btn btn-primary" onclick="startAnalysis()">Start Analysis</button>
                </div>
            </div>

            <div class="section">
                <h2>Analysis Status</h2>
                <div id="analysisStatus" class="status-display">
                    <div class="status-message">No analysis started</div>
                </div>
            </div>

            <div class="section">
                <h2>Analysis Results</h2>
                <div id="analysisResults" class="results-display">
                    <div class="results-message">No results available</div>
                </div>
            </div>
        </div>

        <!-- Person Finder Tab -->
        <div id="finder" class="tab-content">
            <div class="section">
                <h2>Upload Reference Image</h2>
                <form id="imageUploadForm" class="upload-form">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFile" accept="image/*" required>
                        <label for="imageFile" class="file-label">
                            <span class="file-icon">üì∑</span>
                            <span class="file-text">Choose image file...</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload Image</button>
                </form>
            </div>

            <div class="section">
                <h2>Reference Images</h2>
                <div id="imagesList" class="data-list">
                    <div class="loading">Loading images...</div>
                </div>
            </div>

            <div class="section">
                <h2>Search for Person</h2>
                <div class="search-controls">
                    <select id="imageSelect" class="select-input">
                        <option value="">Select a reference image...</option>
                    </select>
                    <button id="searchBtn" class="btn btn-primary" onclick="searchPerson()">Search</button>
                </div>
            </div>

            <div class="section">
                <h2>Search Results</h2>
                <div id="searchResults" class="results-display">
                    <div class="results-message">No search results</div>
                </div>
            </div>
        </div>

        <!-- Health Tab -->
        <div id="health" class="tab-content">
            <div class="section">
                <h2>Service Health</h2>
                <div id="healthStatus" class="health-display">
                    <div class="loading">Checking health...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let currentAnalysisJob = null;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'videos') loadVideos();
            else if (tabName === 'analysis') loadVideosForAnalysis();
            else if (tabName === 'finder') loadImages();
            else if (tabName === 'health') checkHealth();
        }

        // File upload handling
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.querySelector('#videos .file-text').textContent = file.name;
            }
        });

        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.querySelector('#finder .file-text').textContent = file.name;
            }
        });

        // Video upload
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = document.getElementById('videoFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/videos/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Video uploaded successfully!', 'success');
                    loadVideos();
                    document.getElementById('uploadForm').reset();
                    document.querySelector('#videos .file-text').textContent = 'Choose video file...';
                } else {
                    showToast(result.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showToast('Upload failed: ' + error.message, 'error');
            }
        });

        // Image upload
        document.getElementById('imageUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = document.getElementById('imageFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/finder/images/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Image uploaded successfully!', 'success');
                    loadImages();
                    document.getElementById('imageUploadForm').reset();
                    document.querySelector('#finder .file-text').textContent = 'Choose image file...';
                } else {
                    showToast(result.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showToast('Upload failed: ' + error.message, 'error');
            }
        });

        // Load videos
        async function loadVideos() {
            try {
                const response = await fetch(`${API_BASE}/videos`);
                const result = await response.json();
                
                const videosList = document.getElementById('videosList');
                if (result.success && result.videos && result.videos.length > 0) {
                    videosList.innerHTML = result.videos.map(video => `
                        <div class="data-card">
                            <div class="card-header">
                                <h3>${video.original_name}</h3>
                                <span class="status ${video.status}">${video.status}</span>
                            </div>
                            <div class="card-content">
                                <p><strong>ID:</strong> ${video.id}</p>
                                <p><strong>Size:</strong> ${formatFileSize(video.file_size)}</p>
                                <p><strong>Uploaded:</strong> ${new Date(video.uploaded_at).toLocaleString()}</p>
                                ${video.duration ? `<p><strong>Duration:</strong> ${formatDuration(video.duration)}</p>` : ''}
                                ${video.width && video.height ? `<p><strong>Resolution:</strong> ${video.width}x${video.height}</p>` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-danger" onclick="deleteVideo('${video.id}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    videosList.innerHTML = '<div class="empty-state">No videos uploaded yet</div>';
                }
            } catch (error) {
                document.getElementById('videosList').innerHTML = '<div class="error">Failed to load videos</div>';
            }
        }

        // Load videos for analysis
        async function loadVideosForAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/videos`);
                const result = await response.json();
                
                const videoSelect = document.getElementById('videoSelect');
                videoSelect.innerHTML = '<option value="">Select a video...</option>';
                
                if (result.success && result.videos) {
                    result.videos.forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.id;
                        option.textContent = video.original_name;
                        videoSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load videos for analysis:', error);
            }
        }

        // Start analysis
        async function startAnalysis() {
            const videoId = document.getElementById('videoSelect').value;
            if (!videoId) {
                showToast('Please select a video first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/analysis/${videoId}/start`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    currentAnalysisJob = result.job;
                    showToast('Analysis started successfully!', 'success');
                    updateAnalysisStatus();
                } else {
                    showToast(result.message || 'Failed to start analysis', 'error');
                }
            } catch (error) {
                showToast('Failed to start analysis: ' + error.message, 'error');
            }
        }

        // Update analysis status
        async function updateAnalysisStatus() {
            const videoId = document.getElementById('videoSelect').value;
            if (!videoId) return;

            try {
                const response = await fetch(`${API_BASE}/analysis/${videoId}/status`);
                const result = await response.json();
                
                const statusDisplay = document.getElementById('analysisStatus');
                if (result.success) {
                    const job = result.job;
                    statusDisplay.innerHTML = `
                        <div class="status-card ${job.status}">
                            <h3>Analysis Status: ${job.status.toUpperCase()}</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${job.progress}%"></div>
                            </div>
                            <p><strong>Progress:</strong> ${job.progress}%</p>
                            <p><strong>Started:</strong> ${new Date(job.started_at).toLocaleString()}</p>
                            ${job.completed_at ? `<p><strong>Completed:</strong> ${new Date(job.completed_at).toLocaleString()}</p>` : ''}
                            ${job.error ? `<p class="error"><strong>Error:</strong> ${job.error}</p>` : ''}
                        </div>
                    `;

                    if (job.status === 'completed') {
                        getAnalysisResults();
                    } else if (job.status === 'running' || job.status === 'pending') {
                        setTimeout(updateAnalysisStatus, 2000);
                    }
                } else {
                    statusDisplay.innerHTML = '<div class="status-message">No analysis job found</div>';
                }
            } catch (error) {
                document.getElementById('analysisStatus').innerHTML = '<div class="error">Failed to get status</div>';
            }
        }

        // Get analysis results
        async function getAnalysisResults() {
            const videoId = document.getElementById('videoSelect').value;
            if (!videoId) return;

            try {
                const response = await fetch(`${API_BASE}/analysis/${videoId}/enhanced-results`);
                const result = await response.json();
                
                const resultsDisplay = document.getElementById('analysisResults');
                if (result.success) {
                    const data = result.results;
                    
                    // Create stats grid
                    const statsGrid = `
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${data.total_frames}</div>
                                <div class="stat-label">Total Frames</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${data.total_people}</div>
                                <div class="stat-label">Total People</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${data.unique_people}</div>
                                <div class="stat-label">Unique People</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${data.persons ? data.persons.length : 0}</div>
                                <div class="stat-label">Detected Persons</div>
                            </div>
                        </div>
                    `;

                    // Create people grid
                    let peopleGrid = '<div class="people-section"><h3>Detected People</h3><div class="people-grid">';
                    
                    if (data.persons && data.persons.length > 0) {
                        data.persons.forEach((person, index) => {
                            const faceImage = person.best_face && person.best_face.face_image 
                                ? `data:image/svg+xml;base64,${person.best_face.face_image}`
                                : null;
                            
                            peopleGrid += `
                                <div class="person-card">
                                    <div class="person-face">
                                        ${faceImage 
                                            ? `<img src="${faceImage}" alt="Face" class="face-image">`
                                            : '<div class="face-placeholder">üë§</div>'
                                        }
                                    </div>
                                    <div class="person-info">
                                        <h4>Person ${index + 1}</h4>
                                        <p><strong>ID:</strong> ${person.person_id}</p>
                                        <p><strong>First Seen:</strong> ${formatTime(person.first_seen)}</p>
                                        <p><strong>Last Seen:</strong> ${formatTime(person.last_seen)}</p>
                                        <p><strong>Total Frames:</strong> ${person.total_frames}</p>
                                        <p><strong>Duration:</strong> ${formatDuration(person.last_seen - person.first_seen)}</p>
                                        ${person.faces && person.faces.length > 0 
                                            ? `<p><strong>Face Detections:</strong> ${person.faces.length}</p>` 
                                            : ''
                                        }
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        peopleGrid += '<div class="empty-state">No people detected</div>';
                    }
                    
                    peopleGrid += '</div></div>';

                    resultsDisplay.innerHTML = statsGrid + peopleGrid;
                } else {
                    resultsDisplay.innerHTML = '<div class="results-message">No results available</div>';
                }
            } catch (error) {
                document.getElementById('analysisResults').innerHTML = '<div class="error">Failed to get results</div>';
            }
        }

        // Load images
        async function loadImages() {
            try {
                const response = await fetch(`${API_BASE}/finder/images`);
                const result = await response.json();
                
                const imagesList = document.getElementById('imagesList');
                if (result.success && result.images && result.images.length > 0) {
                    imagesList.innerHTML = result.images.map(image => `
                        <div class="data-card">
                            <div class="card-header">
                                <h3>${image.original_name}</h3>
                            </div>
                            <div class="card-content">
                                <p><strong>ID:</strong> ${image.id}</p>
                                <p><strong>Size:</strong> ${formatFileSize(image.file_size)}</p>
                                <p><strong>Uploaded:</strong> ${new Date(image.uploaded_at).toLocaleString()}</p>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-danger" onclick="deleteImage('${image.id}')">Delete</button>
                            </div>
                        </div>
                    `).join('');

                    // Update image select
                    const imageSelect = document.getElementById('imageSelect');
                    imageSelect.innerHTML = '<option value="">Select a reference image...</option>';
                    result.images.forEach(image => {
                        const option = document.createElement('option');
                        option.value = image.id;
                        option.textContent = image.original_name;
                        imageSelect.appendChild(option);
                    });
                } else {
                    imagesList.innerHTML = '<div class="empty-state">No images uploaded yet</div>';
                }
            } catch (error) {
                document.getElementById('imagesList').innerHTML = '<div class="error">Failed to load images</div>';
            }
        }

        // Search person
        async function searchPerson() {
            const imageId = document.getElementById('imageSelect').value;
            if (!imageId) {
                showToast('Please select a reference image first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/finder/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reference_image_id: imageId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Search started successfully!', 'success');
                    // In a real implementation, you would poll for results
                    document.getElementById('searchResults').innerHTML = '<div class="results-message">Search in progress...</div>';
                } else {
                    showToast(result.message || 'Search failed', 'error');
                }
            } catch (error) {
                showToast('Search failed: ' + error.message, 'error');
            }
        }

        // Check health
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                
                const healthDisplay = document.getElementById('healthStatus');
                healthDisplay.innerHTML = `
                    <div class="health-card">
                        <h3>Service Status: ${result.status}</h3>
                        <p><strong>Service:</strong> ${result.service}</p>
                        <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = '<div class="error">Service unavailable</div>';
            }
        }

        // Delete video
        async function deleteVideo(videoId) {
            if (!confirm('Are you sure you want to delete this video?')) return;

            try {
                const response = await fetch(`${API_BASE}/videos/${videoId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Video deleted successfully!', 'success');
                    loadVideos();
                    loadVideosForAnalysis();
                } else {
                    showToast(result.message || 'Delete failed', 'error');
                }
            } catch (error) {
                showToast('Delete failed: ' + error.message, 'error');
            }
        }

        // Delete image
        async function deleteImage(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) return;

            try {
                const response = await fetch(`${API_BASE}/finder/images/${imageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Image deleted successfully!', 'success');
                    loadImages();
                } else {
                    showToast(result.message || 'Delete failed', 'error');
                }
            } catch (error) {
                showToast('Delete failed: ' + error.message, 'error');
            }
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadVideos();
            checkHealth();
        });
    </script>
</body>
</html> 